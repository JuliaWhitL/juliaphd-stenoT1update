be <- meddag
ag <- analyze_graph(be, NULL, "p{Y(L(X = 1), M(L(X = 1), X = 0), X = 1) = 1} - p{Y(L(X = 0), M(L(X = 0), X = 0), X = 0) = 1}")
ag <- analyze_graph(be, NULL, "p{Y(L(A = 1), M(L(A = 1), A = 0), A = 1) = 1} - p{Y(L(A = 0), M(L(A = 0), A = 0), A = 0) = 1}")
bnds <- optimize_effect_2(ag)
bnds
190 + 120
20000 - 2675
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 1)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
optimize_effect_2(amd)
library(causaloptim)
meddag <- specify_graph()
meddag <- specify_graph()
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 1)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
optimize_effect_2(amd)
meddag
meddag <- specify_graph()
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 0)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
optimize_effect_2(amd)
meddag <- specify_graph()
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 0)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
meddag
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 1)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
meddag <- specify_graph()
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 1)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
optimize_effect_2(amd)
amd <- analyze_graph(meddag, NULL, "p{Y(M(A = 0, L(A = 0)), L(A = 1), A = 1) = 1} - p{Y(M(A = 0, L(A = 0)), L(A = 0), A = 0) = 1}")
optimize_effect_2(amd)
cmpdag <- graph_from_literal(X -+ M:Y, M -+ Y, Ur -+ Y:M) |> initialize_graph()
cmpresp <- create_response_function(cmpdag)
reporig <- create_causalmodel(cmpdag, prob.form =  list(cond = "X", out = c("M", "Y")))
## arvid
arvid <- analyze_graph(cmpdag,  constraints = NULL,
"p{Y(M(X = 0), X = 1) = 1} - p{Y(M(X = 0), X = 0) = 1}")
abnds <- optimize_effect_2(arvid)
abnds
optimize_effect_2(amd)
library(causaloptim)
cmpdag <- graph_from_literal(X -+ M:Y, M -+ Y, Ur -+ Y:M) |> initialize_graph()
## arvid
arvid <- analyze_graph(cmpdag,  constraints = NULL,
"p{Y(M(X = 0), X = 1) = 1} - p{Y(M(X = 0), X = 0) = 1}")
abnds <- optimize_effect_2(arvid)
abnds
5600 * 70
---
title: pdflatex fonts
library(causaloptim)
?initialize_graph
ivd <- graph_from_literal(Z -+ X -+ Y, Ur -+ X:Y) |> initialize_graph()
V(ivd)["Y"]
V(ivd)$nvals["Y"] <- 3
V(ivd)["Y"]$nvals
V(ivd)["Y"]$nvals <- 3
analyze_graph(ivd, NULL, "p{Y(X = 1) = 1} - p{Y(X = 0) = 2}")
analyze_graph(ivd, NULL, "p{Y(X = 1) = 1} - p{Y(X = 0) = 2}") |> optimize_effect_2()
?analyze_graph
analyze_graph(ivd, NULL, "p{Y(X = 1) = 2} - p{Y(X = 0) = 2}") |> optimize_effect_2()
library(meraconstraints)
lfd <- caugi(A0 %-->% A1 + M0 + M1 + Y, M0 %-->% A1 + M1 + Y,
A1 %-->% M1 + Y, M1 %-->% Y, U %-->% A0 + A1 + Y)
lfd <- caugi(A0 %-->% A1 + M0 + M1 + Y, M0 %-->% A1 + M1 + Y,
A1 %-->% M1 + Y, M1 %-->% Y, U %-->% A0 + A1 + Y) |> dhvm()
plot(lfd)
mlfd <- meraconstraints(lfd)
lfd <- caugi(A0 %-->% A1 + M0 + M1, M0 %-->% A1 + M1 + Y,
A1 %-->% M1, M1 %-->% Y, U %-->% A0 + A1 + Y) |> dhvm()
plot(lfd)
mlfd <- meraconstraints(lfd)
mlfd
hrep_to_text(mlfd$polytope$Hrep[[1]], mlfd$functional_relations$probform)[mlfd$trivial_if_false[[1]]]
warnings()
hrep_to_text(mlfd$polytope$Hrep[[1]], mlfd$functional_relations$probform[[1]])[mlfd$trivial_if_false[[1]]]
hrep_to_text(mlfd$polytope$Hrep[[1]], mlfd$functional_relations$probform[[1]])[mlfd$trivial_if_false[[1]]] |> cat(sep = "\n")
library(causaloptim)
ivd <- graph_from_literal(Z -+ X -+ Y, Ur -+ X:Y) |> initialize_graph()
analyze_graph(ivd, NULL, "p{Y(X = 1) = 1} - p{Y(X = 0) = 1}") |> optimize_effect_2()
analyze_graph(ivd, NULL, "p{Y(X = 1) = 1} - p{Y(X = 0) = 1}") |> optimize_effect_2()->test
test$bounds_function
sample_distribution(create_causalmodel(ivd, prob.form = list(out = c("X", "Y"), cond = "Z")))
sample_distribution(create_causalmodel(ivd, prob.form = list(out = c("X", "Y"), cond = "Z"))) |> round(2) |> dput()
bstr <- "p00_0 - p00_1 - p10_1 - p01_1, p00_0 - p00_1 - p10_0 - p10_1 - p01_0, p00_0 - p00_1 + p10_0 - 2 * p10_1 - 2 * p01_1, -p10_1 - p01_1, -p10_0 - p01_0, -p00_0 + p00_1 - 2 * p10_0 + p10_1 - 2 * p01_0, -p00_0 + p00_1 - p10_0 - p10_1 - p01_1, -p00_0 + p00_1 - p10_0 - p01_0"
maps <- c(
p00_0 = "ppp[i + 0]",
p00_1 = "ppp[i + 1]",
p10_0 = "ppp[i + 2]",
p10_1 = "ppp[i + 3]",
p01_0 = "ppp[i + 4]",
p01_1 = "ppp[i + 5]",
p11_0 = "ppp[i + 6]",
p11_1 = "ppp[i + 7]"
)
bstr <- "p00_0 - p00_1 - p10_1 - p01_1, p00_0 - p00_1 - p10_0 - p10_1 - p01_0, p00_0 - p00_1 + p10_0 - 2 * p10_1 - 2 * p01_1, -p10_1 - p01_1, -p10_0 - p01_0, -p00_0 + p00_1 - 2 * p10_0 + p10_1 - 2 * p01_0, -p00_0 + p00_1 - p10_0 - p10_1 - p01_1, -p00_0 + p00_1 - p10_0 - p01_0"
maps <- c(
p00_0 = "ppp[i + 0]",
p00_1 = "ppp[i + 1]",
p10_0 = "ppp[i + 2]",
p10_1 = "ppp[i + 3]",
p01_0 = "ppp[i + 4]",
p01_1 = "ppp[i + 5]",
p11_0 = "ppp[i + 6]",
p11_1 = "ppp[i + 7]"
)
for(i in 1:length(maps)) {
bstr <- gsub(names(maps)[i], maps[i], fixed = TRUE)
}
for(i in 1:length(maps)) {
bstr <- gsub(names(maps)[i], maps[i], bstr, fixed = TRUE)
}
bstr
gsub(", ", ").max(", bstr, fixed = TRUE)
bstr <- "1.0 - p10_1 - p01_0, 1.0 + p00_0 + p10_0 - 2.0 * p10_1 -
p01_1, 2.0 - p00_1 - p10_0 - p10_1 - 2.0 * p01_0, 1.0 - p10_1 -
p01_1, 1.0 - p10_0 - p01_0, 1.0 + p00_1 - 2.0 * p10_0 + p10_1 -
p01_0, 2.0 - p00_0 - p10_0 - p10_1 - 2.0 * p01_1, 1.0 - p10_0 -
p01_1"
maps <- c(
p00_0 = "ppp[i + 0]",
p00_1 = "ppp[i + 1]",
p10_0 = "ppp[i + 2]",
p10_1 = "ppp[i + 3]",
p01_0 = "ppp[i + 4]",
p01_1 = "ppp[i + 5]",
p11_0 = "ppp[i + 6]",
p11_1 = "ppp[i + 7]"
)
for(i in 1:length(maps)) {
bstr <- gsub(names(maps)[i], maps[i], bstr, fixed = TRUE)
}
gsub(", ", ").max(", bstr, fixed = TRUE)
bstr <- "1.0 - p10_1 - p01_0, 1.0 + p00_0 + p10_0 - 2.0 * p10_1 - p01_1, 2.0 - p00_1 - p10_0 - p10_1 - 2.0 * p01_0, 1.0 - p10_1 - p01_1, 1.0 - p10_0 - p01_0, 1.0 + p00_1 - 2.0 * p10_0 + p10_1 - p01_0, 2.0 - p00_0 - p10_0 - p10_1 - 2.0 * p01_1, 1.0 - p10_0 - p01_1"
maps <- c(
p00_0 = "ppp[i + 0]",
p00_1 = "ppp[i + 1]",
p10_0 = "ppp[i + 2]",
p10_1 = "ppp[i + 3]",
p01_0 = "ppp[i + 4]",
p01_1 = "ppp[i + 5]",
p11_0 = "ppp[i + 6]",
p11_1 = "ppp[i + 7]"
)
for(i in 1:length(maps)) {
bstr <- gsub(names(maps)[i], maps[i], bstr, fixed = TRUE)
}
gsub(", ", ").max(\n", bstr, fixed = TRUE)
gsub(", ", ").min(\n", bstr, fixed = TRUE)
gsub(", ", ").min(\n", bstr, fixed = TRUE) |> cat()
library(causaloptim)
library(xactonomial)
ivd <- graph_from_literal(Z -+ X -+ Y, Ur -+ X:Y) |> initialize_graph()
bnds <- analyze_graph(ivd, NULL, "p{Y(X = 1) = 1} - p{Y(X = 0) = 1}") |> optimize_effect_2()
ubfunc <- function(theta) {
p00_0 = theta[, 1]
p00_1 = theta[, 5]
p10_0 =theta[, 2]
p10_1 =theta[, 6]
p01_0 =theta[, 3]
p01_1 =theta[, 7]
p11_0 =theta[, 4]
p11_1 =theta[, 8]
pmin(1 - p10_1 - p01_0, 1 + p00_0 + p10_0 - 2 * p10_1 -
p01_1, 2 - p00_1 - p10_0 - p10_1 - 2 * p01_0, 1 - p10_1 -
p01_1, 1 - p10_0 - p01_0, 1 + p00_1 - 2 * p10_0 + p10_1 -
p01_0, 2 - p00_0 - p10_0 - p10_1 - 2 * p01_1, 1 - p10_0 -
p01_1)
}
data <- list(T0 =  c(5, 0,1,4),
T1 = c(0,1, 3,3))
test <- xactonomial(data, f_param = ubfunc, psi0 = .65, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
test
test <- xactonomial(data, f_param = ubfunc, psi0 = .35, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
test <- xactonomial(data, f_param = ubfunc, psi0 = .45, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
data <- list(T0 =  c(5, 0,1,4),
T1 = c(0,4, 3,3))
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE)
test
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE, chunksize = 100)
test
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE, chunksize = 100, ga = FALSE)
test
test$p.sequence
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE, chunksize = 100, ga = FALSE, seed = NULL)
test$p.sequence
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE, chunksize = 100, maxit = 1, ga = FALSE, seed = NULL)
test$p.sequence
test <- xactonomial(data, f_param = ubfunc, psi0 = 0, alternative = "greater",
psi_limits = c(-1, 1), conf_int = FALSE, chunksize = 100, maxit = 1, ga = FALSE, seed = NULL)
test$p.sequence
library(meraconstraints)
library(bench)
bipbell <- caugi(X %-->% A, Y %-->% B, U %-->% A+B)
tribell <- caugi(X %-->% V1, Y %-->% V2, Z %-->% V3, U %-->% V1 + V2 + V3)
iv <- caugi(Z %-->% X %-->% Y, U %-->% X + Y)
sat3 <- caugi(Z %-->% X %-->% Y, Z %-->% Y, U %-->% X + Y)
dbliv <- caugi(V1 %-->% V2 %-->% V3 %-->% V4 %-->% V5, U1 %-->% V2 + V3, U2 %-->% V4 + V5)
triiv <- caugi(V1 %-->% V2 %-->% V3 %-->% V4 %-->% V5 %-->% V6 %-->% V7, U1 %-->% V2 + V3, U2 %-->% V4 + V5, U3 %-->% V6 + V7)
meraconstraints(dhvm(iv, nvals = c(Z = 3, X = 2, Y = 2)))
meraconstraints(dhvm(iv, nvals = c(Z = 3, X = 3, Y = 2)))
meraconstraints(dhvm(iv, nvals = c(Z = 3, X = 3, Y = 3)))
meraconstraints(dhvm(dbliv))
meraconstraints(dhvm(triiv))
meraconstraints(dhvm(sat3))
meraconstraints(dhvm(bipbell))
meraconstraints(dhvm(bipbell, nvals = c(X = 3, Y = 3, A = 2, B = 2)))
### Packages ---
library(lava)
library(data.table)
library(riskRegression)
library(survival)
### Generate 'play' data ---
# Returns data.table with baseline covariates and time to cvd (time,event)
# where event has values 0 for right censored 1 for cvd and 2 for death without cvd.
source("https://raw.githubusercontent.com/JuliaWhitL/juliaphd-stenoT1update/main/simulateStenoT1.R")
set.seed(111)
play <- simulateStenoT1(n=4000)
play <- simulateStenoT1(n=4000)
newdata <- play
source("00-model-specs.R")
setwd("~/Code/julia-ensemble/man")
source("00-model-specs.R")
fullfits <- readRDS("fullfits.rds")
opt.fit <- readRDS("opt-coeffs.rds")
mikes_fit <- structure(list(fullfits = fullfits, opt.coeff = opt.fit), class = "mike")
newdata$value_Albuminuria <- as.factor(newdata$value_Albuminuria)
newdata$age_cat <- as.factor(newdata$age_cat)
Zvalid <- lapply(fullfits, function(f) f(valid))
Zvalid <- lapply(fullfits, function(f) f(newdata))
newdata
newdata$value_Albuminuria <- as.factor(newdata$value_Albuminuria)
newdata$age_cat <- as.factor(ifelse(newdata$age < 40, "young", "old"))
Zvalid <- lapply(fullfits, function(f) f(newdata))
play <- read.csv("training-sample.csv")
play$X <- NULL
play$event <- as.factor(play$event)
play$YY <- survival::Surv(play$time, play$event == 1)
play$time <- NULL
play$event <- NULL
play$value_Albuminuria <- as.factor(play$value_Albuminuria)
play$age_cat <- as.factor(play$age_cat)
devel <- play
colnames(devel)
dput(colnames(devel))
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria")]
Zvalid <- lapply(fullfits, function(f) f(newdata))
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata <- play
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
play
fullfits
simulateStenoT1(n=4000)
simulateStenoT1(n=4000)-> newdata
source("00-model-specs.R")
library(parallel)
play <- read.csv("training-sample.csv")
play$X <- NULL
play$event <- as.factor(play$event)
play$YY <- survival::Surv(play$time, play$event == 1)
play$time <- NULL
play$event <- NULL
play$value_Albuminuria <- as.factor(play$value_Albuminuria)
play$age_cat <- as.factor(play$age_cat)
devel <- play
mymods <- list(stepwise, random.forest, coxboost,
direct.binomial, svm,
function(xx) pseudo.glm(xx, time = 5 ),
function(xx) pseudo.glmnet(xx, time = 5))
set.seed(420)
ndex <- 1:nrow(devel)
part <- as.factor(sample(1:10, length(ndex), replace = TRUE))
folds <- split(ndex, part)
Zout <- vector(mode = "list", length = 10)
for(j in 1:length(folds)) {
training <- devel[unlist(folds[-j]), ]
validation <- devel[folds[[j]], ]
Zout[[j]] <- do.call(cbind, mclapply(mymods, function(f){
fhat <- f(training)
fhat(validation)
}, mc.cores = 7))
}
fullfits <- lapply(mymods, function(f) {
f(devel)
})
saveRDS(fullfits, "fullfits.rds")
saveRDS(Zout, "Zout.rds")
saveRDS(folds, "split.rds")
library(pseudoloss) ## remotes::install_github("sachsmc/pseudoloss")
source("00-model-specs.R")
library(parallel)
Zout <- readRDS("Zout.rds")
fullfits <- readRDS("fullfits.rds")
folds <- readRDS("split.rds")
play <- read.csv("training-sample.csv")
play$X <- NULL
play$event <- as.factor(play$event)
play$YY <- survival::Surv(play$time, play$event == 1)
play$time <- NULL
play$event <- NULL
play$value_Albuminuria <- as.factor(play$value_Albuminuria)
play$age_cat <- as.factor(play$age_cat)
devel <- play
devel$PO <- cumincglm(YY ~ 1, data = devel, time = 5)$y
devel$PO10 <- cumincglm(YY ~ 1, data = devel, time = 10)$y
YYens <- devel$PO[unlist(folds)]
Zmat <- do.call(rbind, Zout)
lassofit <- cv.glmnet(Zmat, YYens, standardize = FALSE, alpha = 0)
lfit <- glmnet(Zmat, YYens, standardize = FALSE,
lambda = lassofit$lambda.1se, alpha = 0)
kcand <- exp(seq(-5, -4))
set.seed(1890)
ndex <- 1:nrow(Zmat)
part <- as.factor(sample(1:10, length(ndex), replace = TRUE))
folds <- split(ndex, part)
cv.auc <- matrix(NA, nrow = 10, ncol = length(kcand))
for(k in 1:length(kcand)) {
#for(i in 1:length(folds)){
resk <- unlist(mclapply(1:length(folds), \(i) {
Zin <- Zmat[unlist(folds[-i]),]
Zout <- Zmat[folds[[i]],]
YYin <- YYens[unlist(folds[-i])]
YYout <- YYens[folds[[i]]]
fn.auc <- function(beta) {
yy <- c(Zin %*% matrix(beta, ncol = 1))
1 - with(calc_roc(yy, matrix(YYin, ncol = 1), ramp = smoothramp),
calc_auc(fpf, tpf)) + k * sum(abs(beta)^2)
}
start.beta <- as.matrix(lfit$beta)[, 1]
opt.fit <- optim(par = start.beta, fn = fn.auc, method = "BFGS")
with(calc_roc((Zout %*% opt.fit$par)[, 1],
matrix(YYout, ncol = 1), smoothramp),
calc_auc(fpf, tpf))
}, mc.cores = 10))
cv.auc[, k] <- resk
}
saveRDS(cv.auc, "cv-aucs-stack.rds")
k <- kcand[which.max(colMeans(cv.auc))]
fn.auc <- function(beta) {
yy <- plogis(c(cbind(1, Zmat) %*% matrix(beta, ncol = 1)))
1 - with(calc_roc(yy, matrix(YYens, ncol = 1), ramp = smoothramp),
calc_auc(fpf, tpf)) + k * sum(abs(beta)^2)
}
start.beta <- c(0, opt.fit$par)
lfit
start.beta <- c(0, lfit$beta)
opt.fit <- optim(par = start.beta, fn = fn.auc, method = "BFGS")
lfit$beta
start.beta <- c(0, unlist(lfit$beta))
start.beta
unlist(c(lfit$beta))
lfit$beta[, 1]
start.beta <- c(0, lfit$beta[, 1])
opt.fit <- optim(par = start.beta, fn = fn.auc, method = "BFGS")
## recalibrate for 10 years
fn.auc <- function(beta) {
yy <- plogis(c(cbind(1, Zmat) %*% matrix(beta, ncol = 1)))
1 - with(calc_roc(yy, matrix(devel$PO10, ncol = 1), ramp = smoothramp),
calc_auc(fpf, tpf)) + k * sum(abs(beta)^2)
}
start.beta <- opt.fit$par
opt.fit10 <- optim(par = start.beta, fn = fn.auc, method = "BFGS")
saveRDS(list(opt.fit5 = opt.fit$par, opt.fit10 = opt.fit10$par), "opt-coeffs.rds")
opt.fit10
source("00-model-specs.R")
fullfits <- readRDS("fullfits.rds")
opt.fit <- readRDS("opt-coeffs.rds")
mikes_fit <- structure(list(fullfits = fullfits, opt.coeff = opt.fit), class = "mike")
source("https://raw.githubusercontent.com/JuliaWhitL/juliaphd-stenoT1update/main/simulateStenoT1.R")
newdata <- simulateStenoT1(n=2000)
source("00-model-specs.R")
fullfits <- readRDS("fullfits.rds")
opt.fit <- readRDS("opt-coeffs.rds")
mikes_fit <- structure(list(fullfits = fullfits, opt.coeff = opt.fit), class = "mike")
### Packages ---
library(lava)
library(data.table)
library(riskRegression)
library(survival)
source("https://raw.githubusercontent.com/JuliaWhitL/juliaphd-stenoT1update/main/simulateStenoT1.R")
newdata <- simulateStenoT1(n=2000)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria", "YY")]
Zvalid <- lapply(fullfits, function(f) f(newdata))
newdata$sex
newdata$value_Smoking <- as.factor(newdata$value_Smoking)
newdata <- simulateStenoT1(n=2000)
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria", "YY")]
summary(newdata)
as.numeric(newdata$sex)
newdata$sex <- as.numeric(as.character(newdata$sex))
newdata$sex
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata <- simulateStenoT1(n=2000)
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata$sex <- as.numeric(as.character(newdata$sex))
newdata$value_Smoking <- as.numeric(as.character(newdata$value_Smoking))
newdata$value_Motion <- as.numeric(as.character(newdata$value_Motion))
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria", "YY")]
Zvalid <- lapply(fullfits, function(f) f(newdata))
x <- mikes_fit
plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit5)
x$opt.coeff$opt.fit5
cbind(1, Zvalid)
Zvalid <- do.call(cbind, Zvalid)
plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit5)
predictRisk.mike <- function(x, newdata, times = c(5, 10), cause = 1) {
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata$sex <- as.numeric(as.character(newdata$sex))
newdata$value_Smoking <- as.numeric(as.character(newdata$value_Smoking))
newdata$value_Motion <- as.numeric(as.character(newdata$value_Motion))
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria", "YY")]
Zvalid <- do.call(cbind, lapply(x$fullfits, function(f) f(newdata)))
remat <- cbind(plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit5),
plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit10))
if(length(times) == 1 && times == 5) {
remat[, 1, drop = FALSE]
} else if (length(times) == 1 && times == 10) {
remat[, 2, drop = FALSE]
} else if (all(times == c(5, 10))) {
remat
} else {
stop("Can't predict at times ", times)
}
}
predictRisk(mikes_fit, newdata)
rm(newdata)
mikes_fit <- structure(list(fullfits = fullfits, opt.coeff = opt.fit), class = "mike")
predictRisk.mike <- function(x, newdata, times = c(5, 10), cause = 1) {
newdata <- as.data.frame(newdata)
newdata$age_cat <- factor(ifelse(newdata$age < 40, "young", "old"))
newdata$macro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Macro", 1, 0)
newdata$micro_Albuminuria <- ifelse(newdata$value_Albuminuria=="Micro", 1, 0)
newdata$YY <- survival::Surv(newdata$time, newdata$event == 1)
newdata$sex <- as.numeric(as.character(newdata$sex))
newdata$value_Smoking <- as.numeric(as.character(newdata$value_Smoking))
newdata$value_Motion <- as.numeric(as.character(newdata$value_Motion))
newdata <- newdata[,c("sex", "age", "diabetes_duration", "value_SBP", "value_LDL",
"value_HBA1C", "value_Smoking", "value_Motion", "value_Albuminuria",
"eGFR", "age_cat", "macro_Albuminuria", "micro_Albuminuria", "YY")]
Zvalid <- do.call(cbind, lapply(x$fullfits, function(f) f(newdata)))
remat <- cbind(plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit5),
plogis(cbind(1, Zvalid) %*% x$opt.coeff$opt.fit10))
if(length(times) == 1 && times == 5) {
remat[, 1, drop = FALSE]
} else if (length(times) == 1 && times == 10) {
remat[, 2, drop = FALSE]
} else if (all(times == c(5, 10))) {
remat
} else {
stop("Can't predict at times ", times)
}
}
newdata <- simulateStenoT1(n=2000)
predictRisk(mikes_fit, newdata)
newdata
preds <- predictRisk(mikes_fit, newdata)
mean((preds[, 1] - newdata$time.event.1 <= 5)^2)
mean((preds[, 1] - (newdata$time.event.1 <= 5))^2)
mean((preds[, 2] - (newdata$time.event.1 <= 10))^2)
